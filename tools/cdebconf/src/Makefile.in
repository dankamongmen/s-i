include ../globalmakeflags

SUBDIR=src

MAJOR=0
MINOR=0
MICRO=0
LDFLAGS=-L. -ldebconf @RPATH@
LIBNAME=libdebconf.so
CLILIB=libdebconfclient.so
CLILIBNAME_A=libdebconfclient.a
CLILIBNAME=$(CLILIB).$(MAJOR).$(MINOR).$(MICRO)
CLISONAME=$(CLILIB).$(MAJOR)
DEBCONF=debconf
TOOLS=debconf-loadtemplate debconf-copydb debconf-communicate dpkg-reconfigure #dpkg-preconfigure
BIN=$(DEBCONF) $(TOOLS)

LIBOBJS=commands.opic configuration.opic confmodule.opic debug.opic \
	database.opic debconfclient.opic frontend.opic priority.opic \
	strutl.opic question.opic template.opic rfc822.opic

CLILIBOBJS=debconfclient.opic

CLILIBOBJS_A=$(CLILIBOBJS:.opic=.o)

all: $(BIN) $(LIBNAME) $(CLILIBNAME) $(CLILIBNAME_A) modules/Makefile
	@$(MAKE) -C modules $@

$(BIN): $(LIBNAME) $(addsuffix .o,$(BIN))
	@for bin in $(BIN); do \
		echo Compiling tool $$bin; \
		$(CC) $(CFLAGS) -o $$bin $$bin.o -Wl,-rpath,${moddir} $(LDFLAGS); \
	done

$(LIBNAME): $(LIBOBJS)
	@echo Creating library $@
	$(CC) $(CFLAGS) -shared -Wl -o $@ $^ -ldl

$(CLILIBNAME): $(CLILIBOBJS)
	@echo Creating shared library $@
	$(CC) $(CFLAGS) -shared -Wl,-soname,$(CLISONAME) -o $@ $^ -ldl

$(CLILIBNAME_A): $(CLILIBOBJS_A)
	$(AR) cr $@ $^
	ranlib $@

$(CLISONAME) $(CLILIB): $(CLILIBNAME)
	-@ln -sf $^ $@

install:
	install -d -m 755 ${bindir}
	install -d -m 755 ${sbindir}
	install -d -m 755 ${etcdir}
	install -d -m 755 ${libdir}
	install -d -m 755 ${moddir}
	install -d -m 755 ${sharedir}
	install -m 755 debconf debconf-loadtemplate ${bindir}
	install -m 755 dpkg-reconfigure ${sbindir}
	install -m 644 $(LIBNAME) ${moddir}
	install -m 644 $(CLILIBNAME) ${libdir}
	ln -sf $(CLILIBNAME) ${libdir}/$(CLISONAME)
	ln -sf $(CLILIBNAME) ${libdir}/$(CLILIB)
	install -m 644 $(CLILIBNAME_A) ${libdir}
	install -m 644 cdebconf.conf-dist ${etcdir}/cdebconf.conf
	install -m 644 ${srcdir}/src/client/confmodule ${sharedir}
	ln -sf ../../bin/$(DEBCONF) ${sharedir}/frontend
ifneq ($(TARGET),udeb)
	install -m 755 debconf debconf-copydb ${bindir}
	install -d -m 755 ${incdir}
	install -m 644 ${srcdir}/src/debconfclient.h ${incdir}
endif
	@$(MAKE) -C modules $@

clean:
	-@rm -f $(BIN) $(LIBNAME) $(CLILIB) $(CLILIBNAME) $(CLILIBNAME_A) $(CLISONAME) *~ *.o *.opic
	@$(MAKE) -C modules clean

.PHONY: clean lib
