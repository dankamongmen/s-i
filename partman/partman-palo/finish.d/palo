#!/bin/sh

. /lib/partman/definitions.sh

have_palo=no
good_place=no

# Is there at least one palo-partition?
for dev in $DEVICES/*; do
    [ -d "$dev" ] || continue
    cd $dev
    partitions=
    open_dialog PARTITIONS
    while { read_line num id size type fs path name; [ "$id" ]; }; do
	[ "$fs" != free ] || continue
	partitions="$partitions $id,$num"
    done
    close_dialog
    
    for part in $partitions; do
	id=${part%,*}
	num=${part#*,}
	[ -f $id/method ] || continue
	method=$(cat $id/method)
	if [ "$method" = palo ]; then
	    end=${id#*-}
	    have_palo=yes
	    if longint_le "$end" 2147483648; then
		good_place=yes
	    fi
	fi
    done
    
done

if [ $good_place = no ]; then
    if [ $have_palo = no ]; then
	db_fset partman-palo/no_palo seen false
	db_input critical partman-palo/no_palo || true
	db_go || exit 1
	db_get partman-palo/no_palo
	if [ "$RET" = 'true' ]; then
	    exit 1
	fi
    else
	db_fset partman-palo/wrong_place seen false
	db_input critical partman-palo/wrong_place || true
	db_go || exit 1
	db_get partman-palo/wrong_place
	if [ "$RET" = 'true' ]; then
	    exit 1
	fi
    fi
fi

exit 0
